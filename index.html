<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة الطالب</title>
    <link rel="icon" href="https://static.vecteezy.com/system/resources/previews/023/221/041/non_2x/open-book-school-supply-icon-free-png.png" type="image/png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts (Tajawal) -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            -webkit-tap-highlight-color: transparent;
        }

        /* iOS Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* iOS Glassmorphism */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Button Press Effect */
        .btn-press:active {
            transform: scale(0.96);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Modal Animation */
        .modal-enter {
            opacity: 0;
            transform: scale(0.9);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.2s, transform 0.2s;
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.2s, transform 0.2s;
        }
    </style>
</head>
<body class="text-white min-h-screen pb-24 selection:bg-blue-500 selection:text-white">

    <!-- Header -->
    <header class="fixed top-0 w-full z-40 glass pt-safe-top transition-all duration-300">
        <div class="flex justify-between items-center px-5 py-4">
            <div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">منصة الطالب</h1>
                <p class="text-xs text-slate-400">متجرك الأول للبحوث والهدايا</p>
            </div>
            <div class="relative">
                <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700 shadow-lg">
                    <i class="fa-solid fa-graduation-cap text-blue-400"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-content" class="pt-24 px-4 fade-in container mx-auto max-w-md">
        
        <!-- VIEW: Home (Research Store) -->
        <div id="view-home" class="view-section">
            <h2 class="text-lg font-bold mb-3 px-1 border-r-4 border-blue-500 pr-2">قسم البحوث والتقارير</h2>
            <!-- Search Bar -->
            <div class="mb-6 relative">
                <input type="text" id="search-input" placeholder="ابحث عن تقرير أو بحث..." 
                    class="w-full bg-slate-800/50 border border-slate-700 rounded-2xl py-3 pr-10 pl-4 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-slate-500">
                <i class="fa-solid fa-search absolute right-4 top-3.5 text-slate-500"></i>
            </div>

            <!-- Categories Research -->
            <div class="flex gap-3 overflow-x-auto no-scrollbar mb-6 pb-2">
                <button onclick="filterProducts('all', 'research')" data-cat="all" class="category-btn-research flex-shrink-0 px-5 py-2 rounded-full bg-blue-600 text-white text-sm font-medium shadow-lg shadow-blue-900/20 transition-all">الكل</button>
                <button onclick="filterProducts('طبية', 'research')" data-cat="طبية" class="category-btn-research flex-shrink-0 px-5 py-2 rounded-full bg-slate-800 text-slate-300 text-sm font-medium border border-slate-700 transition-all">طبية</button>
                <button onclick="filterProducts('هندسية', 'research')" data-cat="هندسية" class="category-btn-research flex-shrink-0 px-5 py-2 rounded-full bg-slate-800 text-slate-300 text-sm font-medium border border-slate-700 transition-all">هندسية</button>
                <button onclick="filterProducts('قانون', 'research')" data-cat="قانون" class="category-btn-research flex-shrink-0 px-5 py-2 rounded-full bg-slate-800 text-slate-300 text-sm font-medium border border-slate-700 transition-all">قانون</button>
            </div>

            <!-- Products Grid -->
            <div id="products-grid" class="grid grid-cols-1 gap-4">
                <div class="text-center py-10 text-slate-500">
                    <div class="loader mx-auto mb-2"></div>
                    جارٍ تحميل البحوث...
                </div>
            </div>
        </div>

        <!-- VIEW: Gifts Store (New) -->
        <div id="view-gifts" class="view-section hidden">
            <h2 class="text-lg font-bold mb-3 px-1 border-r-4 border-purple-500 pr-2">الهدايا والمستلزمات</h2>
            
             <!-- Search Bar Gifts -->
             <div class="mb-6 relative">
                <input type="text" id="search-input-gifts" placeholder="ابحث عن هدية أو كتاب..." 
                    class="w-full bg-slate-800/50 border border-slate-700 rounded-2xl py-3 pr-10 pl-4 text-sm focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all placeholder-slate-500">
                <i class="fa-solid fa-search absolute right-4 top-3.5 text-slate-500"></i>
            </div>

            <!-- Categories Gifts -->
            <div class="flex gap-3 overflow-x-auto no-scrollbar mb-6 pb-2">
                <button onclick="filterProducts('all', 'gift')" data-cat="all" class="category-btn-gift flex-shrink-0 px-5 py-2 rounded-full bg-purple-600 text-white text-sm font-medium shadow-lg shadow-purple-900/20 transition-all">الكل</button>
                <button onclick="filterProducts('كتب', 'gift')" data-cat="كتب" class="category-btn-gift flex-shrink-0 px-5 py-2 rounded-full bg-slate-800 text-slate-300 text-sm font-medium border border-slate-700 transition-all">كتب</button>
                <button onclick="filterProducts('هدايا', 'gift')" data-cat="هدايا" class="category-btn-gift flex-shrink-0 px-5 py-2 rounded-full bg-slate-800 text-slate-300 text-sm font-medium border border-slate-700 transition-all">هدايا وتخرج</button>
                <button onclick="filterProducts('مستلزمات', 'gift')" data-cat="مستلزمات" class="category-btn-gift flex-shrink-0 px-5 py-2 rounded-full bg-slate-800 text-slate-300 text-sm font-medium border border-slate-700 transition-all">مستلزمات</button>
            </div>

            <!-- Gifts Grid -->
            <div id="gifts-grid" class="grid grid-cols-2 gap-3">
                 <!-- Injected via JS -->
            </div>
        </div>

        <!-- VIEW: Custom Request -->
        <div id="view-custom" class="view-section hidden">
            <h2 class="text-xl font-bold mb-4 px-1">طلب خاص</h2>
            <div class="glass-card rounded-2xl p-5 shadow-lg">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">عنوان البحث / اسم الهدية</label>
                        <input type="text" id="custom-title" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 focus:border-blue-500 outline-none transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">التفاصيل المطلوبة</label>
                        <textarea id="custom-details" rows="4" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 focus:border-blue-500 outline-none transition-colors" placeholder="اكتب تفاصيل طلبك هنا (عنوان البحث، مواصفات الهدية، نوع الكتاب...)"></textarea>
                    </div>
                    <button onclick="openOrderModal('طلب خاص', 0, 'custom')" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 py-3.5 rounded-xl font-bold shadow-lg shadow-blue-900/30 btn-press">
                        الانتقال لإكمال الطلب
                    </button>
                </div>
            </div>
            
            <div class="mt-6 p-4 rounded-2xl bg-slate-800/30 border border-slate-700/50">
                <div class="flex items-start gap-3">
                    <i class="fa-solid fa-circle-info text-blue-400 mt-1"></i>
                    <p class="text-sm text-slate-400 leading-relaxed">
                        سيتم مراجعة طلبك وتحديد السعر المناسب ومن ثم التواصل معك عبر رقم الهاتف لتأكيد البدء بالعمل.
                    </p>
                </div>
            </div>
        </div>

        <!-- VIEW: Admin Login / Dashboard -->
        <div id="view-admin" class="view-section hidden">
            
            <!-- Login Screen -->
            <div id="admin-login-screen" class="flex flex-col items-center justify-center py-10">
                <div class="w-16 h-16 rounded-2xl bg-slate-800 flex items-center justify-center mb-6 shadow-xl border border-slate-700">
                    <i class="fa-solid fa-lock text-2xl text-red-500"></i>
                </div>
                <h2 class="text-xl font-bold mb-2">دخول المشرف</h2>
                <p class="text-slate-400 text-sm mb-6">يرجى إدخال كلمة المرور للمتابعة</p>
                
                <input type="password" id="admin-password" placeholder="كلمة المرور" class="w-full max-w-xs bg-slate-800 border border-slate-700 rounded-xl p-3 mb-4 text-center focus:border-red-500 outline-none">
                <button onclick="checkAdmin()" class="w-full max-w-xs bg-slate-700 hover:bg-slate-600 py-3 rounded-xl font-medium transition-colors btn-press">دخول</button>
                <p id="login-error" class="text-red-500 text-sm mt-3 hidden">كلمة المرور غير صحيحة</p>
            </div>

            <!-- Dashboard Screen -->
            <div id="admin-dashboard" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">لوحة التحكم</h2>
                    <button onclick="logoutAdmin()" class="text-xs text-red-400 border border-red-400/30 px-3 py-1 rounded-lg">خروج</button>
                </div>

                <!-- Tabs for Admin -->
                <div class="flex gap-2 mb-6 bg-slate-800 p-1 rounded-xl">
                    <button onclick="switchAdminTab('orders')" id="tab-btn-orders" class="flex-1 py-2 rounded-lg text-xs font-medium bg-slate-600 text-white shadow">الطلبات</button>
                    <button onclick="switchAdminTab('products')" id="tab-btn-products" class="flex-1 py-2 rounded-lg text-xs font-medium text-slate-400 hover:bg-slate-700/50">المنتجات</button>
                    <button onclick="switchAdminTab('add-product')" id="tab-btn-add" class="flex-1 py-2 rounded-lg text-xs font-medium text-slate-400 hover:bg-slate-700/50">نشر جديد</button>
                </div>

                <!-- Admin: Orders List -->
                <div id="admin-view-orders">
                    <div id="orders-list" class="space-y-3">
                        <div class="text-center text-slate-500 py-4">جاري تحميل الطلبات...</div>
                    </div>
                </div>

                <!-- Admin: Manage Products List -->
                <div id="admin-view-products" class="hidden">
                     <!-- Filter Toggles for Admin -->
                     <div class="flex gap-2 mb-4">
                        <button onclick="filterAdminList('all')" id="filter-admin-all" class="flex-1 py-2 rounded-xl text-xs font-medium bg-slate-600 text-white transition-all shadow">الكل</button>
                        <button onclick="filterAdminList('research')" id="filter-admin-research" class="flex-1 py-2 rounded-xl text-xs font-medium bg-slate-800 text-slate-400 border border-slate-700 transition-all">البحوث</button>
                        <button onclick="filterAdminList('gift')" id="filter-admin-gift" class="flex-1 py-2 rounded-xl text-xs font-medium bg-slate-800 text-slate-400 border border-slate-700 transition-all">المتجر</button>
                    </div>

                    <div id="admin-products-list" class="space-y-3 pb-20">
                        <div class="text-center text-slate-500 py-4">جاري تحميل المنتجات...</div>
                    </div>
                </div>

                <!-- Admin: Add/Edit Product -->
                <div id="admin-view-add" class="hidden">
                    <div class="glass-card p-5 rounded-2xl space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 id="form-title" class="font-bold text-blue-400 mb-2">إضافة منتج جديد</h3>
                            <button onclick="resetForm()" class="text-[10px] text-slate-400 bg-slate-800 px-2 py-1 rounded hidden" id="reset-form-btn">إلغاء التعديل</button>
                        </div>
                        
                        <input type="hidden" id="edit-prod-id">
                        
                        <!-- Section Selector -->
                        <div class="bg-slate-800 p-2 rounded-xl mb-2">
                             <label class="block text-[10px] text-slate-400 mb-1 px-1">القسم</label>
                             <div class="flex gap-2">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="prod-section" value="research" class="peer hidden" checked>
                                    <div class="text-center py-2 rounded-lg bg-slate-900 border border-slate-700 text-slate-400 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-500 text-xs transition-all">بحوث وتقارير</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="prod-section" value="gift" class="peer hidden">
                                    <div class="text-center py-2 rounded-lg bg-slate-900 border border-slate-700 text-slate-400 peer-checked:bg-purple-600 peer-checked:text-white peer-checked:border-purple-500 text-xs transition-all">هدايا ومستلزمات</div>
                                </label>
                             </div>
                        </div>

                        <input type="text" id="new-prod-title" placeholder="العنوان" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl text-sm focus:border-blue-500 outline-none">
                        <input type="text" id="new-prod-price" placeholder="السعر (مثال: 15,000)" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl text-sm focus:border-blue-500 outline-none">
                        
                        <!-- Image Input (URL + File) -->
                        <div class="space-y-2">
                            <input type="text" id="new-prod-image" placeholder="رابط الصورة (URL)" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl text-sm focus:border-blue-500 outline-none">
                            <div class="relative">
                                <input type="file" id="new-prod-file" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
                                <label for="new-prod-file" class="flex items-center justify-center w-full p-3 bg-slate-800 border border-dashed border-slate-600 rounded-xl cursor-pointer hover:border-blue-500 text-xs text-slate-400 gap-2">
                                    <i class="fa-solid fa-cloud-arrow-up"></i>
                                    <span id="file-label">أو اختر صورة من الجهاز</span>
                                </label>
                            </div>
                        </div>

                        <!-- Tag Selector -->
                        <select id="new-prod-tag" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl text-sm text-slate-400 outline-none">
                            <optgroup label="بحوث وتقارير">
                                <option value="عام">عام</option>
                                <option value="طبية">طبية</option>
                                <option value="هندسية">هندسية</option>
                                <option value="إدارة">إدارة واقتصاد</option>
                                <option value="قانون">قانون</option>
                            </optgroup>
                            <optgroup label="هدايا ومستلزمات">
                                <option value="كتب">كتب وملازم</option>
                                <option value="هدايا">هدايا وتخرج</option>
                                <option value="مستلزمات">مستلزمات دراسية</option>
                                <option value="طباعة">طباعة وتصوير</option>
                            </optgroup>
                        </select>

                        <button onclick="saveProduct()" id="save-prod-btn" class="w-full bg-green-600 hover:bg-green-500 py-3 rounded-xl font-bold btn-press shadow-lg shadow-green-900/20">نشر</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation (iOS Style) -->
    <nav class="fixed bottom-0 w-full glass pb-safe-bottom z-50">
        <div class="flex justify-around items-center pt-3 pb-4 px-2">
            <button onclick="switchTab('home')" class="nav-btn flex flex-col items-center gap-1 w-1/4 text-blue-500" data-target="view-home">
                <i class="fa-solid fa-book-open text-xl mb-0.5"></i>
                <span class="text-[10px] font-medium">البحوث</span>
            </button>
            <button onclick="switchTab('gifts')" class="nav-btn flex flex-col items-center gap-1 w-1/4 text-slate-500" data-target="view-gifts">
                <i class="fa-solid fa-gift text-xl mb-0.5"></i>
                <span class="text-[10px] font-medium">المتجر</span>
            </button>
            <button onclick="switchTab('custom')" class="nav-btn flex flex-col items-center gap-1 w-1/4 text-slate-500" data-target="view-custom">
                <i class="fa-solid fa-pen-to-square text-xl mb-0.5"></i>
                <span class="text-[10px] font-medium">طلب خاص</span>
            </button>
            <button onclick="switchTab('admin')" class="nav-btn flex flex-col items-center gap-1 w-1/4 text-slate-500" data-target="view-admin">
                <i class="fa-solid fa-user-shield text-xl mb-0.5"></i>
                <span class="text-[10px] font-medium">الإدارة</span>
            </button>
        </div>
    </nav>

    <!-- Order Modal -->
    <div id="order-modal" class="fixed inset-0 z-[60] hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeOrderModal()"></div>
        
        <!-- Modal Content -->
        <div class="absolute bottom-0 w-full bg-slate-900 rounded-t-3xl p-6 transform transition-transform duration-300 translate-y-full" id="order-modal-content">
            <div class="w-12 h-1.5 bg-slate-700 rounded-full mx-auto mb-6"></div>
            
            <h3 class="text-xl font-bold mb-1">إكمال الطلب</h3>
            <p id="modal-item-name" class="text-slate-400 text-sm mb-6">اسم العنصر</p>

            <form id="order-form" onsubmit="submitOrder(event)" class="space-y-4">
                <input type="hidden" id="order-item-id">
                <input type="hidden" id="order-item-type"> <!-- 'product' or 'custom' -->
                <input type="hidden" id="order-item-price">
                
                <div class="relative">
                    <i class="fa-solid fa-user absolute right-4 top-3.5 text-slate-500 text-sm"></i>
                    <input type="text" id="customer-name" required placeholder="الاسم الكامل" class="w-full bg-slate-800 border border-slate-700 rounded-xl py-3 pr-10 pl-4 text-sm focus:border-blue-500 outline-none">
                </div>

                <div class="relative">
                    <i class="fa-solid fa-phone absolute right-4 top-3.5 text-slate-500 text-sm"></i>
                    <input type="tel" id="customer-phone" required placeholder="رقم الهاتف" class="w-full bg-slate-800 border border-slate-700 rounded-xl py-3 pr-10 pl-4 text-sm focus:border-blue-500 outline-none">
                </div>

                <div class="relative">
                    <i class="fa-solid fa-location-dot absolute right-4 top-3.5 text-slate-500 text-sm"></i>
                    <input type="text" id="customer-address" required placeholder="العنوان (المحافظة / المنطقة)" class="w-full bg-slate-800 border border-slate-700 rounded-xl py-3 pr-10 pl-4 text-sm focus:border-blue-500 outline-none">
                </div>

                <button type="submit" id="confirm-order-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl mt-4 shadow-lg shadow-blue-900/40 btn-press flex justify-center items-center gap-2">
                    <span>تأكيد الطلب</span>
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </form>
            <div class="h-8"></div> <!-- Spacer for safe area -->
        </div>
    </div>

    <!-- Delete Confirmation Modal (New) -->
    <div id="delete-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeDeleteModal()"></div>
        
        <!-- Modal Content -->
        <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl relative z-10 w-11/12 max-w-sm text-center border border-slate-700 transform transition-all" id="delete-modal-box">
            <div class="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                <i class="fa-solid fa-trash-can text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-white mb-2">حذف المنتج؟</h3>
            <p class="text-slate-400 text-sm mb-6">هل أنت متأكد من رغبتك في حذف هذا المنتج نهائياً؟ لا يمكن التراجع عن هذا الإجراء.</p>
            
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-300 font-medium btn-press hover:bg-slate-600 transition-colors">إلغاء</button>
                <button onclick="confirmDeleteAction()" class="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold btn-press shadow-lg shadow-red-900/20 hover:bg-red-500 transition-colors">نعم، حذف</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 border border-slate-600 text-white px-6 py-3 rounded-full shadow-2xl z-[70] flex items-center gap-3 transition-all duration-300 opacity-0 pointer-events-none translate-y-[-20px]">
        <i class="fa-solid fa-check-circle text-green-500"></i>
        <span id="toast-message" class="text-sm font-medium">تمت العملية بنجاح</span>
    </div>

    <!-- Firebase & Logic Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Setup ---
        const userProvidedConfig = {
            apiKey: "AIzaSyD6MRZ7d7J1333erYoBrUGqocJNdGNjB7w",
            authDomain: "neew-aec2b.firebaseapp.com",
            databaseURL: "https://neew-aec2b-default-rtdb.firebaseio.com",
            projectId: "neew-aec2b",
            storageBucket: "neew-aec2b.firebasestorage.app",
            messagingSenderId: "70112873200",
            appId: "1:70112873200:web:b8ef2b3863be6f1bf39035"
        };

        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : userProvidedConfig;
        const appId = (typeof __app_id !== 'undefined') ? __app_id : "student-platform-default";
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let products = [];
        let isAdminLoggedIn = false;
        let isDemoMode = false; 
        let productToDeleteId = null;
        let currentResearchCategory = 'all';
        let currentGiftCategory = 'all';
        let currentAdminFilter = 'all'; // For Admin Panel
        let tempBase64Image = null; // Store base64 image temporarily

        // Initialize App
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Init Error", error);
                isDemoMode = true;
                showToast("وضع العرض (بدون اتصال)", true);
                renderEmptyState();
            }
        }

        // Listen for auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Logged in:", user.uid);
                fetchProducts();
            } else {
                console.log("No user");
            }
        });

        // --- Data Operations ---

        // Fetch Products (Read Public Data)
        async function fetchProducts() {
            if(isDemoMode) { renderEmptyState(); return; }

            const grid = document.getElementById('products-grid');
            try {
                const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
                const q = query(productsRef);
                const snapshot = await getDocs(q);
                
                products = [];
                snapshot.forEach(doc => {
                    products.push({ id: doc.id, ...doc.data() });
                });

                if (products.length === 0) {
                    renderEmptyState();
                } else {
                    renderProducts();
                    renderGifts();
                    if(isAdminLoggedIn) fetchAdminProducts(); // Update admin view if logged in
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                isDemoMode = true;
                renderEmptyState();
                if(error.code === 'permission-denied' || error.message.includes('permission')) {
                     showToast("تنبيه: تعمل المنصة ببيانات تجريبية", true);
                }
            }
        }

        // Filter for Admin List
        window.filterAdminList = function(type) {
            currentAdminFilter = type;
            
            // UI Toggle
            const btnIds = ['all', 'research', 'gift'];
            btnIds.forEach(id => {
                const btn = document.getElementById(`filter-admin-${id}`);
                if(id === type) {
                    btn.classList.remove('bg-slate-800', 'text-slate-400', 'border', 'border-slate-700');
                    btn.classList.add('bg-slate-600', 'text-white', 'shadow');
                } else {
                    btn.classList.add('bg-slate-800', 'text-slate-400', 'border', 'border-slate-700');
                    btn.classList.remove('bg-slate-600', 'text-white', 'shadow');
                }
            });

            fetchAdminProducts();
        }

        // Fetch Products for Admin List
        window.fetchAdminProducts = function() {
            const list = document.getElementById('admin-products-list');
            
            // Filter list based on currentAdminFilter
            let displayList = products;
            if(currentAdminFilter === 'research') {
                displayList = products.filter(p => !p.section || p.section === 'research');
            } else if (currentAdminFilter === 'gift') {
                displayList = products.filter(p => p.section === 'gift');
            }

            if (displayList.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-500 py-6">لا توجد منتجات في هذا القسم</div>';
                return;
            }

            list.innerHTML = displayList.map(product => `
                <div class="bg-slate-700/50 p-3 rounded-xl border border-slate-600 flex items-center gap-3 animate-fade-in">
                    <img src="${product.image}" class="w-12 h-12 rounded-lg object-cover bg-slate-800" onerror="this.src='https://placehold.co/100x100'">
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-white text-sm truncate">${product.title}</h4>
                        <div class="flex gap-2 text-[10px] text-slate-400">
                             <span>${product.price}</span>
                             <span class="border-r border-slate-600 pr-2">${product.section === 'gift' ? 'هدايا' : 'بحث'}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editProduct('${product.id}')" class="w-8 h-8 rounded-lg bg-blue-600/20 text-blue-400 flex items-center justify-center hover:bg-blue-600 hover:text-white transition-colors">
                            <i class="fa-solid fa-pen text-xs"></i>
                        </button>
                        <button onclick="openDeleteModal('${product.id}')" class="w-8 h-8 rounded-lg bg-red-600/20 text-red-400 flex items-center justify-center hover:bg-red-600 hover:text-white transition-colors">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // --- Delete Logic ---
        window.openDeleteModal = function(id) {
            productToDeleteId = id;
            const modal = document.getElementById('delete-modal');
            const box = document.getElementById('delete-modal-box');
            
            modal.classList.remove('hidden');
            box.classList.add('modal-enter-active');
            setTimeout(() => {
                box.classList.remove('modal-enter-active');
            }, 200);
        }

        window.closeDeleteModal = function() {
            const modal = document.getElementById('delete-modal');
            productToDeleteId = null;
            modal.classList.add('hidden');
        }

        window.confirmDeleteAction = async function() {
            if(!productToDeleteId) return;
            
            if(isDemoMode) {
                showToast("لا يمكن الحذف في الوضع التجريبي", true);
                closeDeleteModal();
                return;
            }

            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', productToDeleteId));
                showToast("تم الحذف بنجاح");
                await fetchProducts(); // fetchProducts will call fetchAdminProducts
            } catch (error) {
                console.error("Delete Error", error);
                showToast("حدث خطأ أثناء الحذف", true);
            } finally {
                closeDeleteModal();
            }
        }

        // --- Add/Edit Logic ---

        // File Selection
        window.handleFileSelect = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempBase64Image = e.target.result;
                    document.getElementById('file-label').innerText = "تم اختيار الصورة";
                    document.getElementById('file-label').classList.add('text-green-400');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.editProduct = function(id) {
            const product = products.find(p => p.id === id);
            if(!product) return;

            document.getElementById('edit-prod-id').value = product.id;
            document.getElementById('new-prod-title').value = product.title;
            document.getElementById('new-prod-price').value = product.price;
            document.getElementById('new-prod-image').value = product.image; // Keep URL if exists
            document.getElementById('new-prod-tag').value = product.tag || 'عام';
            
            // Set Section Correctly
            const section = product.section || 'research';
            const radios = document.getElementsByName('prod-section');
            for(let radio of radios) {
                if(radio.value === section) radio.checked = true;
            }

            // UI Changes
            document.getElementById('form-title').innerText = "تعديل المنتج";
            document.getElementById('save-prod-btn').innerText = "حفظ التعديلات";
            document.getElementById('save-prod-btn').classList.remove('bg-green-600', 'hover:bg-green-500');
            document.getElementById('save-prod-btn').classList.add('bg-blue-600', 'hover:bg-blue-500');
            document.getElementById('reset-form-btn').classList.remove('hidden');
            
            tempBase64Image = null; // Reset temp image
            document.getElementById('file-label').innerText = "أو اختر صورة جديدة";
            document.getElementById('file-label').classList.remove('text-green-400');

            switchAdminTab('add-product');
        }

        window.resetForm = function() {
            document.getElementById('edit-prod-id').value = "";
            document.getElementById('new-prod-title').value = "";
            document.getElementById('new-prod-price').value = "";
            document.getElementById('new-prod-image').value = "";
            document.getElementById('new-prod-file').value = "";
            document.getElementById('new-prod-tag').value = "عام";
            
            // Default section
            document.getElementsByName('prod-section')[0].checked = true;

            document.getElementById('form-title').innerText = "إضافة منتج جديد";
            document.getElementById('save-prod-btn').innerText = "نشر";
            document.getElementById('save-prod-btn').classList.add('bg-green-600', 'hover:bg-green-500');
            document.getElementById('save-prod-btn').classList.remove('bg-blue-600', 'hover:bg-blue-500');
            document.getElementById('reset-form-btn').classList.add('hidden');
            
            tempBase64Image = null;
            document.getElementById('file-label').innerText = "أو اختر صورة من الجهاز";
            document.getElementById('file-label').classList.remove('text-green-400');
        }

        window.saveProduct = async function() {
            if(isDemoMode) {
                showToast("لا يمكن التعديل في الوضع التجريبي", true);
                return;
            }

            const id = document.getElementById('edit-prod-id').value;
            const title = document.getElementById('new-prod-title').value;
            const price = document.getElementById('new-prod-price').value;
            const imageUrl = document.getElementById('new-prod-image').value;
            const tag = document.getElementById('new-prod-tag').value;
            
            let section = 'research';
            const radios = document.getElementsByName('prod-section');
            for(let radio of radios) {
                if(radio.checked) section = radio.value;
            }

            if(!title || !price) {
                showToast("يرجى ملء العنوان والسعر", true);
                return;
            }

            // Determine Image source (File > URL > Placeholder)
            let finalImage = tempBase64Image || imageUrl || "https://images.unsplash.com/photo-1532012197267-da84d127e765?w=500&auto=format&fit=crop&q=60";

            const btn = document.getElementById('save-prod-btn');
            const originalText = btn.innerText;
            btn.innerHTML = '<div class="loader border-white/30 border-t-white w-5 h-5"></div>';
            
            try {
                const productData = {
                    title,
                    price,
                    image: finalImage,
                    tag,
                    section, // 'research' or 'gift'
                    updatedAt: serverTimestamp()
                };

                if (id) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id), productData);
                    showToast("تم تحديث المنتج");
                } else {
                    productData.createdAt = serverTimestamp();
                    const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
                    await addDoc(productsRef, productData);
                    showToast("تم النشر بنجاح");
                }
                
                resetForm();
                fetchProducts();
            } catch (e) {
                console.error(e);
                showToast("فشل العملية", true);
            } finally {
                btn.innerText = id ? "حفظ التعديلات" : "نشر";
            }
        }

        // Submit Order (Customer)
        window.submitOrder = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('confirm-order-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader border-white/30 border-t-white"></div>';

            const name = document.getElementById('customer-name').value;
            const phone = document.getElementById('customer-phone').value;
            const address = document.getElementById('customer-address').value;
            const itemName = document.getElementById('modal-item-name').innerText;
            const itemId = document.getElementById('order-item-id').value;
            const type = document.getElementById('order-item-type').value;

            const orderData = {
                customerName: name,
                customerPhone: phone,
                customerAddress: address,
                itemName: itemName,
                itemId: itemId,
                type: type,
                details: type === 'custom' ? document.getElementById('custom-details').value : "منتج جاهز",
                status: 'pending',
                orderDate: new Date().toISOString(),
                timestamp: serverTimestamp()
            };

            try {
                if(isDemoMode) {
                    await new Promise(r => setTimeout(r, 1000));
                    console.log("Demo Order:", orderData);
                } else {
                    const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                    await addDoc(ordersRef, orderData);
                }

                closeOrderModal();
                showToast("تم إرسال طلبك بنجاح!");
                document.getElementById('order-form').reset();
                if(type === 'custom') {
                    document.getElementById('custom-title').value = "";
                    document.getElementById('custom-details').value = "";
                    switchTab('home');
                }

            } catch (error) {
                console.error(error);
                showToast("حدث خطأ في الإرسال", true);
            } finally {
                btn.innerHTML = originalText;
            }
        }

        // Fetch Orders (Admin)
        async function fetchOrders() {
            const list = document.getElementById('orders-list');
            list.innerHTML = '<div class="text-center py-4"><div class="loader mx-auto"></div></div>';
            
            if (isDemoMode) {
                list.innerHTML = `<div class="bg-slate-700/50 p-4 rounded-xl border border-yellow-600/50 text-center text-yellow-500 mb-4 text-xs">وضع العرض التجريبي</div>`;
                return;
            }

            try {
                const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                const snapshot = await getDocs(ordersRef);
                let orders = [];
                snapshot.forEach(doc => orders.push({id: doc.id, ...doc.data()}));
                orders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

                if (orders.length === 0) {
                    list.innerHTML = '<div class="text-center text-slate-500 py-6">لا توجد طلبات حالياً</div>';
                    return;
                }

                list.innerHTML = orders.map(order => `
                    <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-white text-sm">${order.itemName}</h4>
                                <span class="text-xs ${order.type === 'custom' ? 'text-purple-400' : 'text-blue-400'} bg-slate-800 px-2 py-0.5 rounded">${order.type === 'custom' ? 'طلب خاص' : 'شراء مباشر'}</span>
                            </div>
                            <span class="text-[10px] text-slate-400">${order.orderDate ? new Date(order.orderDate).toLocaleDateString('ar-IQ') : 'الآن'}</span>
                        </div>
                        <div class="space-y-1 text-xs text-slate-300 bg-slate-800 p-2 rounded-lg">
                            <p><i class="fa-solid fa-user ml-2 w-4"></i> ${order.customerName}</p>
                            <p><i class="fa-solid fa-phone ml-2 w-4"></i> ${order.customerPhone}</p>
                            <p><i class="fa-solid fa-map-marker-alt ml-2 w-4"></i> ${order.customerAddress}</p>
                            ${order.type === 'custom' ? `<p class="mt-2 pt-2 border-t border-slate-700 text-slate-400 italic">"${order.details}"</p>` : ''}
                        </div>
                        <div class="mt-3 flex gap-2">
                            <a href="tel:${order.customerPhone}" class="flex-1 bg-green-600 hover:bg-green-500 text-center py-1.5 rounded-lg text-xs font-bold">اتصال</a>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                list.innerHTML = `<div class="text-red-400 text-center text-xs">خطأ: ${error.message}</div>`;
            }
        }

        // --- UI Rendering ---

        window.filterProducts = function(category, section) {
            if(section === 'research') {
                currentResearchCategory = category;
                // UI update for Research buttons
                document.querySelectorAll('.category-btn-research').forEach(btn => {
                    if(btn.dataset.cat === category) btn.classList.replace('bg-slate-800', 'bg-blue-600');
                    else btn.classList.replace('bg-blue-600', 'bg-slate-800');
                });
                renderProducts();
            } else {
                currentGiftCategory = category;
                // UI update for Gift buttons
                document.querySelectorAll('.category-btn-gift').forEach(btn => {
                    if(btn.dataset.cat === category) btn.classList.replace('bg-slate-800', 'bg-purple-600');
                    else btn.classList.replace('bg-purple-600', 'bg-slate-800');
                });
                renderGifts();
            }
        }

        // Render Research Products
        function renderProducts() {
            const grid = document.getElementById('products-grid');
            
            // Filter Research products ONLY
            let displayProducts = products.filter(p => !p.section || p.section === 'research');
            
            if (currentResearchCategory !== 'all') {
                displayProducts = displayProducts.filter(p => p.tag === currentResearchCategory);
            }

            if (displayProducts.length === 0) {
                 grid.innerHTML = `<div class="text-center py-20 text-slate-500 col-span-1">
                        <i class="fa-solid fa-box-open text-4xl mb-4 opacity-50"></i>
                        <p>لا توجد بحوث في هذا القسم.</p>
                    </div>`;
                 return;
            }

            grid.innerHTML = displayProducts.map(product => `
                <div class="glass-card rounded-2xl p-3 flex gap-4 items-center animate-fade-in relative group overflow-hidden">
                    <div class="w-24 h-24 rounded-xl bg-slate-800 flex-shrink-0 overflow-hidden relative">
                         <img src="${product.image}" alt="${product.title}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100x100/1e293b/FFF?text=PDF'">
                         <div class="absolute top-0 right-0 bg-blue-600 px-2 py-1 text-[10px] rounded-bl-lg text-white font-bold shadow text-center leading-3">
                            ${product.price}
                            <div class="text-[8px] font-normal opacity-90">شامل التوصيل</div>
                         </div>
                    </div>
                    <div class="flex-1">
                        <span class="text-[10px] text-slate-400 border border-slate-600 px-1.5 py-0.5 rounded-md mb-1 inline-block">${product.tag || 'عام'}</span>
                        <h3 class="font-bold text-base leading-tight mb-1 text-white">${product.title}</h3>
                        <p class="text-xs text-slate-400 mb-3 line-clamp-2">بحث متكامل جاهز للطباعة والتعديل.</p>
                        <button onclick="openOrderModal('${product.title}', '${product.price}', 'product', '${product.id}')" 
                            class="bg-slate-700 hover:bg-blue-600 text-white text-xs py-2 px-4 rounded-lg w-full transition-colors flex items-center justify-center gap-2 btn-press border border-slate-600 hover:border-blue-500">
                            <span>طلب الآن</span>
                            <i class="fa-solid fa-cart-shopping text-[10px]"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Render Gift Products
        function renderGifts() {
            const grid = document.getElementById('gifts-grid');
            
            // Filter Gift products ONLY
            let displayProducts = products.filter(p => p.section === 'gift');
            
            if (currentGiftCategory !== 'all') {
                displayProducts = displayProducts.filter(p => p.tag === currentGiftCategory);
            }

            if (displayProducts.length === 0) {
                 grid.innerHTML = `<div class="text-center py-20 text-slate-500 col-span-2">
                        <i class="fa-solid fa-gift text-4xl mb-4 opacity-50 text-purple-500"></i>
                        <p>لا توجد منتجات في هذا القسم.</p>
                    </div>`;
                 return;
            }

            grid.innerHTML = displayProducts.map(product => `
                <div class="glass-card rounded-2xl p-3 flex flex-col gap-2 animate-fade-in relative group overflow-hidden">
                    <div class="w-full aspect-square rounded-xl bg-slate-800 overflow-hidden relative">
                         <img src="${product.image}" alt="${product.title}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200x200/1e293b/FFF?text=GIFT'">
                         <div class="absolute bottom-2 right-2 bg-purple-600 px-2 py-1 text-[10px] rounded-lg text-white font-bold shadow opacity-90">
                            ${product.price}
                         </div>
                    </div>
                    <div>
                        <span class="text-[9px] text-purple-300 bg-purple-900/30 px-1.5 py-0.5 rounded mb-1 inline-block">${product.tag || 'عام'}</span>
                        <h3 class="font-bold text-sm leading-tight mb-1 text-white line-clamp-1">${product.title}</h3>
                        <button onclick="openOrderModal('${product.title}', '${product.price}', 'product', '${product.id}')" 
                            class="mt-2 bg-slate-700 hover:bg-purple-600 text-white text-xs py-2 w-full rounded-lg transition-colors btn-press border border-slate-600 hover:border-purple-500">
                            طلب
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderEmptyState() {
            products = [
                // --- Research (بحوث) ---
                
                // Medical (طبية)
                { id: 'm1', title: 'تأثير المضادات الحيوية', price: '15,000', tag: 'طبية', section: 'research', image: 'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=500&q=60' },
                { id: 'm2', title: 'ارتفاع ضغط الدم: الأسباب والعلاج', price: '15,000', tag: 'طبية', section: 'research', image: 'https://images.unsplash.com/photo-1628348068343-c6a848d2b6dd?w=500&q=60' },
                { id: 'm3', title: 'دور التغذية في تعزيز المناعة', price: '15,000', tag: 'طبية', section: 'research', image: 'https://images.unsplash.com/photo-1498837167922-ddd27525d352?w=500&q=60' },
                { id: 'm4', title: 'تقنيات التمريض الحديثة', price: '15,000', tag: 'طبية', section: 'research', image: 'https://images.unsplash.com/photo-1584515933487-779824d29309?w=500&q=60' },
                { id: 'm5', title: 'الأمراض المعدية والوقاية منها', price: '15,000', tag: 'طبية', section: 'research', image: 'https://images.unsplash.com/photo-1584036561566-baf8f5f1b144?w=500&q=60' },

                // Engineering (هندسة الحاسوب)
                { id: 'e1', title: 'مادة دوائر الكترونية', price: '15,000', tag: 'هندسية', section: 'research', image: 'https://images.unsplash.com/photo-1517077304055-6e89abbf09b0?w=500&q=60' },
                { id: 'e2', title: 'معمارية الحاسوب', price: '15,000', tag: 'هندسية', section: 'research', image: 'https://images.unsplash.com/photo-1555680202-c86f0e12f086?w=500&q=60' },
                { id: 'e3', title: 'الأنظمة المدمجة (Embedded Systems)', price: '15,000', tag: 'هندسية', section: 'research', image: 'https://images.unsplash.com/photo-1518770660439-4636190af475?w=500&q=60' },
                { id: 'e4', title: 'أمن المعلومات والشبكات', price: '15,000', tag: 'هندسية', section: 'research', image: 'https://images.unsplash.com/photo-1550751827-4bd374c3f58b?w=500&q=60' },
                { id: 'e5', title: 'إنترنت الأشياء (IoT)', price: '15,000', tag: 'هندسية', section: 'research', image: 'https://images.unsplash.com/photo-1558346490-a72e53ae2d4f?w=500&q=60' },
                
                // Law (قانون)
                { id: 'l1', title: 'الحماية الجنائية للملكية الفكرية', price: '15,000', tag: 'قانون', section: 'research', image: 'https://images.unsplash.com/photo-1589829085413-56de8ae18c73?w=500&q=60' },
                { id: 'l2', title: 'حقوق الإنسان في الدساتير', price: '15,000', tag: 'قانون', section: 'research', image: 'https://images.unsplash.com/photo-1453928582365-b6ad33cbcf64?w=500&q=60' },
                { id: 'l3', title: 'الجرائم الالكترونية في القانون', price: '15,000', tag: 'قانون', section: 'research', image: 'https://images.unsplash.com/photo-1505664194779-8beaceb93744?w=500&q=60' },

                // --- Gifts & Accessories ---
                { id: 'g1', title: 'ساعة رجالية فخمة', price: '25,000', tag: 'هدايا', section: 'gift', image: 'https://images.unsplash.com/photo-1523170335258-f5ed11844a49?w=500&q=60' },
                { id: 'g2', title: 'بكج تخرج (درع + وشاح)', price: '30,000', tag: 'هدايا', section: 'gift', image: 'https://images.unsplash.com/photo-1523580494863-6f3031224c94?w=500&q=60' },
                { id: 'g3', title: 'جلسة تصوير تخرج خاصة', price: '50,000', tag: 'هدايا', section: 'gift', image: 'https://images.unsplash.com/photo-1627556592933-ffe99c1cd9eb?w=500&q=60' },
                { id: 'g4', title: 'لوحة تخرج خشبية', price: '10,000', tag: 'طباعة', section: 'gift', image: 'https://images.unsplash.com/photo-1577083552431-6e5fd01aa342?w=500&q=60' },
                
                // --- Supplies & Books ---
                { id: 's1', title: 'حاسبة علمية Casio', price: '20,000', tag: 'مستلزمات', section: 'gift', image: 'https://images.unsplash.com/photo-1587145820266-a795ddd7d397?w=500&q=60' },
                { id: 'b1', title: 'كتاب Clean Code (هندسة حاسوب)', price: '12,000', tag: 'كتب', section: 'gift', image: 'https://images.unsplash.com/photo-1517694712202-14dd9538aa97?w=500&q=60' },
                { id: 'b2', title: 'مصطلحات طبية (Medical Terms)', price: '10,000', tag: 'كتب', section: 'gift', image: 'https://images.unsplash.com/photo-1581093450021-4a7360e9a6b5?w=500&q=60' },
                { id: 'b3', title: 'الوجيز في القانون المدني', price: '15,000', tag: 'كتب', section: 'gift', image: 'https://images.unsplash.com/photo-1589829085413-56de8ae18c73?w=500&q=60' },
                { id: 'b4', title: 'English Grammar in Use', price: '8,000', tag: 'كتب', section: 'gift', image: 'https://images.unsplash.com/photo-1457369804613-52c61a468e7d?w=500&q=60' },
            ];
            renderProducts();
            renderGifts();
            if(isAdminLoggedIn) fetchAdminProducts();
        }

        // --- UI Interactions ---

        window.switchTab = function(tabName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-blue-500');
                btn.classList.add('text-slate-500');
            });

            if (tabName === 'home') {
                document.getElementById('view-home').classList.remove('hidden');
                document.querySelector('[data-target="view-home"]').classList.add('text-blue-500');
                document.querySelector('[data-target="view-home"]').classList.remove('text-slate-500');
            } else if (tabName === 'gifts') {
                document.getElementById('view-gifts').classList.remove('hidden');
                document.querySelector('[data-target="view-gifts"]').classList.add('text-blue-500');
                document.querySelector('[data-target="view-gifts"]').classList.remove('text-slate-500');
            } else if (tabName === 'custom') {
                document.getElementById('view-custom').classList.remove('hidden');
                document.querySelector('[data-target="view-custom"]').classList.add('text-blue-500');
                document.querySelector('[data-target="view-custom"]').classList.remove('text-slate-500');
            } else if (tabName === 'admin') {
                document.getElementById('view-admin').classList.remove('hidden');
                document.querySelector('[data-target="view-admin"]').classList.add('text-blue-500');
                document.querySelector('[data-target="view-admin"]').classList.remove('text-slate-500');
                
                if(isAdminLoggedIn) fetchOrders();
            }
        }

        // Admin Auth
        window.checkAdmin = function() {
            const pass = document.getElementById('admin-password').value;
            if (pass === 'alikuka') {
                isAdminLoggedIn = true;
                document.getElementById('admin-login-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                fetchOrders();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        window.logoutAdmin = function() {
            isAdminLoggedIn = false;
            document.getElementById('admin-password').value = '';
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('admin-login-screen').classList.remove('hidden');
        }

        window.switchAdminTab = function(tab) {
            ['orders', 'products', 'add'].forEach(t => {
                const btn = document.getElementById(`tab-btn-${t}`);
                if(t === 'add') t = 'add-product'; 
                btn.classList.remove('bg-slate-600', 'text-white');
                btn.classList.add('text-slate-400');
            });
            
            document.getElementById('admin-view-orders').classList.add('hidden');
            document.getElementById('admin-view-products').classList.add('hidden');
            document.getElementById('admin-view-add').classList.add('hidden');

            if(tab === 'orders') {
                document.getElementById('admin-view-orders').classList.remove('hidden');
                document.getElementById('tab-btn-orders').classList.add('bg-slate-600', 'text-white');
                document.getElementById('tab-btn-orders').classList.remove('text-slate-400');
                fetchOrders();
            } 
            else if (tab === 'products') {
                document.getElementById('admin-view-products').classList.remove('hidden');
                document.getElementById('tab-btn-products').classList.add('bg-slate-600', 'text-white');
                document.getElementById('tab-btn-products').classList.remove('text-slate-400');
                fetchAdminProducts();
            }
            else if (tab === 'add-product') {
                document.getElementById('admin-view-add').classList.remove('hidden');
                document.getElementById('tab-btn-add').classList.add('bg-slate-600', 'text-white');
                document.getElementById('tab-btn-add').classList.remove('text-slate-400');
            }
        }

        // Modal Logic
        window.openOrderModal = function(title, price, type, id = 'new') {
            if (type === 'custom') {
                const customTitle = document.getElementById('custom-title').value;
                if(!customTitle) {
                    showToast('يرجى كتابة العنوان', true);
                    return;
                }
                title = customTitle;
                price = "حسب الاتفاق";
            }

            document.getElementById('modal-item-name').innerText = title;
            document.getElementById('order-item-id').value = id;
            document.getElementById('order-item-type').value = type;
            document.getElementById('order-item-price').value = price;
            
            const modal = document.getElementById('order-modal');
            const content = document.getElementById('order-modal-content');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('translate-y-full');
            }, 10);
        }

        window.closeOrderModal = function() {
            const modal = document.getElementById('order-modal');
            const content = document.getElementById('order-modal-content');
            
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        window.showToast = function(msg, isError = false) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-message');
            const icon = toast.querySelector('i');
            
            toastMsg.innerText = msg;
            
            if(isError) {
                icon.className = 'fa-solid fa-circle-exclamation text-red-500';
            } else {
                icon.className = 'fa-solid fa-check-circle text-green-500';
            }

            toast.classList.remove('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
            }, 3000);
        }

        // Start Auth Flow
        initAuth();

    </script>
</body>
</html>
